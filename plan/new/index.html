<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>WWPM - Dashboard</title>

    <link href="../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="../../vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">
    <link href="../../css/sb-admin.css" rel="stylesheet">

</head>

<body id="page-top">
    <nav id="nav-top" class="navbar navbar-expand navbar-dark bg-dark static-top"></nav>
    <div id="wrapper">
        <ul id="nav-menu" class="sidebar navbar-nav"></ul>

        <div id="content-wrapper">

            <div class="container-fluid">

                <!-- Breadcrumbs-->
                <ol class="breadcrumb">
                    <!-- <li class="breadcrumb-item">
                        <a href="../list/">Plan List</a>
                    </li> -->
                    <li class="breadcrumb-item active">New Plan</li>
                </ol>

                <!-- /////////////////////////////////[Code]///////////////////////////////////////////////// -->

                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-table"></i>
                        New plan
                    </div>
                </div>
                <div id="accordion" class="card-body">

                    <div id="headingOne">
                        <button class="float-right btn btn-dark" id="addplan">
                            <h5 class="mb-0">
                                <i class="far fa-calendar-plus" data-toggle="collapse" data-target="#collapseOne"
                                    aria-expanded="true" aria-controls="collapseOne">
                                    Add Plan</i>
                            </h5>
                        </button>

                    </div>
                    <div id="collapseOne" class="collapse hide" aria-labelledby="headingOne" data-parent="#accordion">
                        <div class="card-body">
                            <form id="PlanList" class="form-inline">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Plan</span>
                                    </div>
                                    <input type="text" class="form-control" id="ProjectTitle" placeholder="Plan name">
                                </div>

                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Start</span>
                                    </div>
                                    <input class="form-control" id="SiteId" placeholder="Start Date">
                                </div>

                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Expire</span>
                                    </div>
                                    <input class="form-control" id="SiteReport" placeholder="Expire Date">
                                </div>

                            </form>

                            <div class="float-none">
                                <label class="btn btn-outline-success">Import CSV
                                    <input type="file" id="fileinput" style="display:none" />
                                </label>
                                <label class="float-left btn btn-outline-info" id="downloadform" onclick="downform()">
                                    <i class="fas fa-file-download"> Template</i>
                                </label>
                                <!-- <input id="myInput" type="text" placeholder="Search.."> -->
                                <!-- <a href="#"><i class="far fa-check-circle" id="clear-filter" data-role="fieldcontain"></i></a> -->
                                <label id="Sub-btn" class="btn btn-outline-primary collapse" data-toggle="collapse"
                                    data-target="#collapseOne">Submit</label>

                                <label id="cancelplan" data-toggle="collapse" data-target="#collapseOne" class="btn btn-outline-danger collapse">
                                    <i class="fas fa-ban"></i> cancel</label>


                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-body">


                    <div id="formdataTable"></div>

                </div>
                <!-- <p id="export"></p> -->

                <script type="text/javascript">
                    var result = [];

                    function CSVtoArray(text) {
                        var re_valid = /^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;
                        var re_value = /(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;
                        // Return NULL if input string is not well formed CSV string.
                        if (!re_valid.test(text)) return null;
                        var a = [];                     // Initialize array to receive values.
                        text.replace(re_value, // "Walk" the string using replace with callback.
                            function (m0, m1, m2, m3) {
                                // Remove backslash from \' in single quoted values.
                                if (m1 !== undefined) a.push(m1.replace(/\\'/g, "'"));
                                // Remove backslash from \" in double quoted values.
                                else if (m2 !== undefined) a.push(m2.replace(/\\"/g, '"'));
                                else if (m3 !== undefined) a.push(m3);
                                return ''; // Return empty string.
                            });
                        // Handle special case of empty last value.
                        if (/,\s*$/.test(text)) a.push('');
                        return a;
                    };

                    function readSingleFile(evt) {
                        var f = evt.target.files[0];

                        if (f) {
                            var r = new FileReader();
                            r.onload = function (e) {
                                var csv = e.target.result;

                                // csv = csv.match(/\w+|"(?:\\"|[^"])+"/g);
                                // console.log(csv)
                                // var row = contents.split("\r\n");
                                var lines = csv.split("\r\n");
                                var headers = lines[2].split(",");

                                for (var i = 4; i < lines.length; i++) {
                                    // console.log(CSVtoArray(lines[i - 1]));

                                    var obj = {};
                                    var currentline = CSVtoArray(lines[i - 1]);

                                    for (var j = 0; j < headers.length; j++) {
                                        obj[headers[j]] = currentline[j];
                                    }

                                    result.push(obj);

                                }
                                // EXTRACT VALUE FOR HTML HEADER. 
                                var col = [];
                                for (var i = 0; i < result.length; i++) {
                                    for (var key in result[i]) {
                                        if (col.indexOf(key) === -1) {
                                            col.push(key);
                                        }
                                    }
                                }

                                // CREATE DYNAMIC TABLE.
                                var table = document.createElement("table");
                                table.setAttribute("class", "table table-bordered table-responsive-md table-striped text-center");
                                // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

                                var tr = table.insertRow(-1);                   // TABLE ROW.

                                for (var i = 0; i < col.length; i++) {
                                    var th = document.createElement("th");
                                    th.setAttribute("class", "text-center");    // TABLE HEADER.
                                    th.innerHTML = col[i];
                                    tr.appendChild(th);
                                }

                                // ADD JSON DATA TO THE TABLE AS ROWS.
                                for (var i = 0; i < result.length; i++) {

                                    tr = table.insertRow(-1);

                                    for (var j = 0; j < col.length; j++) {
                                        var tabCell = tr.insertCell(-1);
                                        tabCell.setAttribute("contenteditable", "true")
                                        tabCell.innerHTML = result[i][col[j]];

                                    }
                                }

                                // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
                                var divContainer = document.getElementById("formdataTable");
                                divContainer.innerHTML = "";
                                divContainer.appendChild(table);
                                $("#Sub-btn").show();
                                $("#cancelplan").show();

                                $('#cancelplan').click(function () {
                                    divContainer.innerHTML = "";
                                    setTimeout("location.reload(true);", 100);
                                })

                                var $TABLE = $('#formdataTable');
                                var $BTN = $('#Sub-btn');
                                // var $EXPORT = $('#export');

                                jQuery.fn.pop = [].pop;
                                jQuery.fn.shift = [].shift;

                                var Plan = $("#ProjectTitle").val();
                                var Start = $("#SiteId").val();
                                var Expire = $("#SiteReport").val();
                                $BTN.click(function () {
                                    var $rows = $TABLE.find('tr:not(:hidden)');
                                    var headers = [];
                                    var data = [];

                                    // Get the headers (add special header logic here)
                                    $($rows.shift()).find('th:not(:empty)').each(function () {
                                        headers.push($(this).text());
                                    });

                                    // Turn all existing rows into a loopable array
                                    $rows.each(function () {
                                        var $td = $(this).find('td');
                                        var h = {};

                                        // Use the headers from earlier to name our hash keys
                                        headers.forEach(function (header, i) {
                                            h[header.trim().replace(" ", "")] = $td.eq(i).text();
                                        });

                                        data.push(h);
                                    });

                                    // Output the result
                                    // $EXPORT.text(JSON.stringify(data));
                                    var fair = JSON.stringify(data);
                                    console.log(fair);
                                    firebase.database().ref('PMplan').push({
                                        JSON: fair,
                                        "Plan": Plan,
                                        "Start": Start,
                                        "Expire": Expire
                                    })
                                    divContainer.innerHTML = "";
                                    // $('#ProjectTitle').val('');
                                    // $('#SiteId').val('');
                                    // $('#SiteReport').val('');
                                    // $("#Sub-btn").hide();
                                    // $("#cancelplan").hide();
                                    setTimeout("location.reload(true);", 3000);

                                });

                            }
                            r.readAsText(f);
                        } else {
                            alert("Failed to load file");
                        }
                    }

                    document.getElementById('fileinput').addEventListener('change', readSingleFile, false);

                </script>

                <script>
                    function downform() {
                        console.log('download...');
                        var storageRef = firebase.storage();
                        var path = storageRef.ref();
                        var form = path.child('Form-Template/form.csv');
                        form.getDownloadURL().then(function (url) {
                            console.log(url);
                            myFunction(url)
                        });
                    };

                    function myFunction(url) {
                        window.open(url);
                    }
                </script>

<!-- 

                <!-- /.container-fluid -->

                <!-- Sticky Footer -->
                <footer id="footer" class="sticky-footer" />

            </div>
            <!-- /.content-wrapper -->

        </div>
        <!-- /#wrapper -->

        <div id="ex-event" />

        <script src="../../vendor/jquery/jquery.min.js"></script>
        <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

        <!-- <script src="../vendor/jquery-easing/jquery.easing.min.js"></script> -->

        <!-- Page level plugin JavaScript-->
        <!-- <script src="../../vendor/chart.js/Chart.min.js"></script> -->
        <script src="../../vendor/datatables/jquery.dataTables.js"></script>
        <script src="../../vendor/datatables/dataTables.bootstrap4.js"></script>

        <!-- Custom scripts for all pages-->
        <!-- <script src="../js/sb-admin.min.js"></script> -->

        <!-- Demo scripts for this page-->
        <!-- <script src="../js/demo/datatables-demo.js"></script> -->
        <!-- <script src="../js/demo/chart-area-demo.js"></script> -->

        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-storage.js"></script>

        <script src="../../firebase/init.js"></script>
        <script src="../../js/route.js"></script>


</body>

</html>