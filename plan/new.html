<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>WWPM - Dashboard</title>

    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="../vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">
    <link href="../css/sb-admin.css" rel="stylesheet">

</head>

<body id="page-top">
    <nav id="nav-top" class="navbar navbar-expand navbar-dark bg-dark static-top"></nav>
    <div id="wrapper">
        <ul id="nav-menu" class="sidebar navbar-nav"></ul>

        <div id="content-wrapper">

            <div class="container-fluid">

                <!-- Breadcrumbs-->
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="#">Plan</a>
                    </li>
                    <li class="breadcrumb-item active">New plan</li>
                </ol>

                <!-- /////////////////////////////////[Code]///////////////////////////////////////////////// -->

                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-table"></i>
                        New plan
                        <label class="btn btn-success float-right btn-sm">Import CSV
                            <input type="file" id="fileinput" style="display:none" />
                        </label>
                    </div>

                    <div class="card-body">
                        <div class="table-responsive">
                            <div id="dataTable_wrapper" class="dataTables_wrapper dt-bootstrap4">
                                <div class="row">
                                    <div class="col-sm-12 col-md-6">
                                        <div class="dataTables_length" id="dataTable_length"><label>Show <select name="dataTable_length"
                                                    aria-controls="dataTable" class="custom-select custom-select-sm form-control form-control-sm">
                                                    <option value="10">10</option>
                                                    <option value="25">25</option>
                                                    <option value="50">50</option>
                                                    <option value="100">100</option>
                                                </select> entries</label></div>
                                    </div>
                                    <div class="col-sm-12 col-md-6">
                                        <div id="dataTable_filter" class="dataTables_filter"><label>Search:<input type="search"
                                                    class="form-control form-control-sm" placeholder="" aria-controls="dataTable"></label></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <table class="table table-bordered dataTable" id="dataTable" width="100%"
                                            cellspacing="0" role="grid" aria-describedby="dataTable_info" style="width: 100%;">

                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12 col-md-5">
                                        <div class="dataTables_info" id="dataTable_info" role="status" aria-live="polite">Showing
                                            1 to 10 of 57 entries</div>
                                    </div>
                                    <div class="col-sm-12 col-md-7">
                                        <div class="dataTables_paginate paging_simple_numbers" id="dataTable_paginate">
                                            <ul class="pagination">
                                                <li class="paginate_button page-item previous disabled" id="dataTable_previous"><a
                                                        href="#" aria-controls="dataTable" data-dt-idx="0" tabindex="0"
                                                        class="page-link">Previous</a></li>
                                                <li class="paginate_button page-item active"><a href="#" aria-controls="dataTable"
                                                        data-dt-idx="1" tabindex="0" class="page-link">1</a></li>
                                                <li class="paginate_button page-item "><a href="#" aria-controls="dataTable"
                                                        data-dt-idx="2" tabindex="0" class="page-link">2</a></li>
                                                <li class="paginate_button page-item "><a href="#" aria-controls="dataTable"
                                                        data-dt-idx="3" tabindex="0" class="page-link">3</a></li>
                                                <li class="paginate_button page-item "><a href="#" aria-controls="dataTable"
                                                        data-dt-idx="4" tabindex="0" class="page-link">4</a></li>
                                                <li class="paginate_button page-item "><a href="#" aria-controls="dataTable"
                                                        data-dt-idx="5" tabindex="0" class="page-link">5</a></li>
                                                <li class="paginate_button page-item "><a href="#" aria-controls="dataTable"
                                                        data-dt-idx="6" tabindex="0" class="page-link">6</a></li>
                                                <li class="paginate_button page-item next" id="dataTable_next"><a href="#"
                                                        aria-controls="dataTable" data-dt-idx="7" tabindex="0" class="page-link">Next</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <p id="export"></p>


                    <script type="text/javascript">
                        function readSingleFile(evt) {
                            var f = evt.target.files[0];

                            if (f) {
                                var r = new FileReader();
                                r.onload = function (e) {
                                    var csv = e.target.result;
                                    // console.log(csv);
                                    // var row = contents.split("\r\n");
                                    var lines = csv.split("\r\n");

                                    var result = [];

                                    var headers = lines[2].split(",");

                                    for (var i = 4; i < lines.length; i++) {

                                        var obj = {};
                                        var currentline = lines[i - 1].split(",");

                                        for (var j = 0; j < headers.length; j++) {
                                            obj[headers[j]] = currentline[j];
                                        }

                                        result.push(obj);

                                    }

                                    // var fair = JSON.stringify(result);
                                    // console.log(fair);

                                    // EXTRACT VALUE FOR HTML HEADER. 
                                    var col = [];
                                    for (var i = 0; i < result.length; i++) {
                                        for (var key in result[i]) {
                                            if (col.indexOf(key) === -1) {
                                                col.push(key);
                                            }
                                        }
                                    }

                                    // CREATE DYNAMIC TABLE.
                                    var table = document.createElement("table");
                                    table.setAttribute("class", "table table-bordered table-responsive-md table-striped text-center");
                                    // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

                                    var tr = table.insertRow(-1);                   // TABLE ROW.

                                    for (var i = 0; i < col.length; i++) {
                                        var th = document.createElement("th");
                                        th.setAttribute("class", "text-center");    // TABLE HEADER.
                                        th.innerHTML = col[i];
                                        tr.appendChild(th);
                                    }

                                    // ADD JSON DATA TO THE TABLE AS ROWS.
                                    for (var i = 0; i < result.length; i++) {

                                        tr = table.insertRow(-1);

                                        for (var j = 0; j < col.length; j++) {
                                            var tabCell = tr.insertCell(-1);
                                            tabCell.setAttribute("contenteditable", "true")
                                            tabCell.innerHTML = result[i][col[j]];

                                        }
                                    }

                                    // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
                                    var divContainer = document.getElementById("dataTable");
                                    divContainer.innerHTML = "";
                                    divContainer.appendChild(table);
                                    var submitBTN = document.createElement("button");
                                    submitBTN.setAttribute("class", "btn btn-primary float-right btn-sm");
                                    submitBTN.setAttribute("id", "Sub-btn");
                                    var t = document.createTextNode("Submit");
                                    submitBTN.appendChild(t);
                                    divContainer.appendChild(submitBTN);
                                    divContainer.DataTable();
                                    var $TABLE = $('#dataTable');
                                    var $BTN = $('#Sub-btn');
                                    var $EXPORT = $('#export');

                                    jQuery.fn.pop = [].pop;
                                    jQuery.fn.shift = [].shift;

                                    $BTN.click(function () {
                                        var $rows = $TABLE.find('tr:not(:hidden)');
                                        var headers = [];
                                        var data = [];

                                        // Get the headers (add special header logic here)
                                        $($rows.shift()).find('th:not(:empty)').each(function () {
                                            headers.push($(this).text().toLowerCase());
                                        });

                                        // Turn all existing rows into a loopable array
                                        $rows.each(function () {
                                            var $td = $(this).find('td');
                                            var h = {};

                                            // Use the headers from earlier to name our hash keys
                                            headers.forEach(function (header, i) {
                                                h[header] = $td.eq(i).text();
                                            });

                                            data.push(h);
                                        });

                                        // Output the result
                                        $EXPORT.text(JSON.stringify(data));
                                        var fair = JSON.stringify(data);
                                        console.log(fair);
                                        firebase.database().ref('PMplan').push({
                                            JSON: fair,
                                            Location: 'Bangkok',
                                            Equipment: 'Air',
                                            Site: 'BKK001',
                                            StartDate: '1/1/18',
                                            ExpDate: '9/9/18',
                                            By: 'Fair'
                                        })
                                    });

                                }
                                r.readAsText(f);
                            } else {
                                alert("Failed to load file");
                            }
                        }

                        document.getElementById('fileinput').addEventListener('change', readSingleFile, false);

                    </script>


                </div>
                <!-- /.container-fluid -->

                <!-- Sticky Footer -->
                <footer id="footer" class="sticky-footer" />

            </div>
            <!-- /.content-wrapper -->

        </div>
        <!-- /#wrapper -->

        <div id="ex-event" />

        <script src="../vendor/jquery/jquery.min.js"></script>
        <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

        <!-- <script src="../vendor/jquery-easing/jquery.easing.min.js"></script> -->

        <!-- Page level plugin JavaScript-->
        <script src="../vendor/chart.js/Chart.min.js"></script>
        <script src="../vendor/datatables/jquery.dataTables.js"></script>
        <script src="../vendor/datatables/dataTables.bootstrap4.js"></script>

        <!-- Custom scripts for all pages-->
        <!-- <script src="../js/sb-admin.min.js"></script> -->

        <!-- Demo scripts for this page-->
        <!-- <script src="../js/demo/datatables-demo.js"></script> -->
        <script src="../js/demo/chart-area-demo.js"></script>

        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
        <script src="../firebase/init.js"></script>
        <script src="../js/route.js"></script>

</body>

</html>