<!doctype html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>WWPM - Form</title>

    <link href="../../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="../../vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">
    <link href="../../css/sb-admin.css" rel="stylesheet">


</head>

<body id="page-top">
    <nav id="nav-top" class="navbar navbar-expand navbar-dark bg-dark static-top"></nav>
    <div id="wrapper">
        <ul id="nav-menu" class="sidebar navbar-nav"></ul>

        <div id="content-wrapper">

            <div class="container-fluid">

                <!-- Breadcrumbs-->
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="#">Form</a>
                    </li>
                    <li class="breadcrumb-item active">New Form</li>
                </ol>
                <!-- /////////////////[card red green blue yellow]////////////////// -->

                <!-- /////////////////////////////////[Code]/////////////////////////////////// -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="fas fa-table"></i> New Form
                    </div>
                    <div class="card-body">
                        <div id="NewForm">
                            <div class="content-newform">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="input-group ">
                                            <div class="input-group-prepend">
                                                <div class="input-group-text form-control">Form Name</div>
                                            </div>
                                            <input type="text" class="form-control" id="FormInputt" placeholder="PM Form v0.0"><br />
                                            <div class="input-group-prepend">
                                                <div class="input-group-text form-control">Appover</div>
                                            </div>
                                            <input type="number" class="form-control" id="AppoverR" placeholder="Number">
                                            <label class="btn btn-warning btn-file">
                                                CSV <input type="file" id="fileinput" style="display:none">
                                            </label>
                                            <div id="accordion">
                                                <a class="collapsed card-link btn btn-info" data-toggle="collapse" href="#collapseTwo">+Add</a>
                                            </div>
                                        </div>
                                        <div id="collapseTwo" class="collapse" data-parent="#accordion">
                                            <div class="card-body border">
                                                <!-- form -->
                                                <div class="container">
                                                    <input type="text" name="text1" id="text1">
                                                    <button type="submit" class="btn btn-primary" id="Bbtn_submitT">NameHead</button>
                                                    <button type="button" class="btn btn-success" id="json">Json</button>

                                                    <div id="render"></div>
                                                </div>
                                                <!-- form -->
                                            </div>
                                        </div>
                                    </div>


                                </div>
                                <div class="footer-newform">
                                    <button type="button" class="btn btn-success" id="FormSumit" onclick="writeNewPost()">Submit</button>
                                </div>
                                <div id="table"></div>
                                <p id="export"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /////////////////////////////////[Code]//////////////////////////////////// -->
            </div>
            <!-- /.container-fluid -->

            <!-- Sticky Footer -->
            <footer id="footer" class="sticky-footer" />

        </div>
        <!-- /.content-wrapper -->

    </div>
    <!-- /#wrapper -->


    <script type="text/javascript">
        var result = [];

        function readSingleFile(evt) {
            var f = evt.target.files[0];

            if (f) {
                var r = new FileReader();
                r.onload = function (e) {
                    var csv = e.target.result;
                    // console.log(csv);
                    // var row = contents.split("\r\n");
                    var lines = csv.split("\r\n");
                    var headers = lines[2].split(",");

                    for (var i = 4; i < lines.length; i++) {

                        var obj = {};
                        var currentline = lines[i - 1].split(",");

                        for (var j = 0; j < headers.length; j++) {
                            obj[headers[j]] = currentline[j];
                        }

                        result.push(obj);

                    }
                    // EXTRACT VALUE FOR HTML HEADER. 
                    var col = [];
                    for (var i = 0; i < result.length; i++) {
                        for (var key in result[i]) {
                            if (col.indexOf(key) === -1) {
                                col.push(key);
                            }
                        }
                    }

                    // CREATE DYNAMIC TABLE.
                    var table = document.createElement("table");
                    table.setAttribute("class", "table table-bordered table-responsive-md table-striped text-center");
                    // CREATE HTML TABLE HEADER ROW USING THE EXTRACTED HEADERS ABOVE.

                    var tr = table.insertRow(-1);                   // TABLE ROW.

                    for (var i = 0; i < col.length; i++) {
                        var th = document.createElement("th");
                        th.setAttribute("class", "text-center");    // TABLE HEADER.
                        th.innerHTML = col[i];
                        tr.appendChild(th);
                    }

                    // ADD JSON DATA TO THE TABLE AS ROWS.
                    for (var i = 0; i < result.length; i++) {

                        tr = table.insertRow(-1);

                        for (var j = 0; j < col.length; j++) {
                            var tabCell = tr.insertCell(-1);
                            tabCell.setAttribute("contenteditable", "true")
                            tabCell.innerHTML = result[i][col[j]];

                        }
                    }

                    // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
                    var divContainer = document.getElementById("table");
                    divContainer.innerHTML = "";
                    divContainer.appendChild(table);

                    var $TABLE = $('#table');
                    var $BTN = $('#FormSumit');
                    var $EXPORT = $('#export');

                    jQuery.fn.pop = [].pop;
                    jQuery.fn.shift = [].shift;

                    $BTN.click(function () {
                        var $rows = $TABLE.find('tr:not(:hidden)');
                        var headers = [];
                        var data = [];

                        // Get the headers (add special header logic here)
                        $($rows.shift()).find('th:not(:empty)').each(function () {
                            headers.push($(this).text());
                        });

                        // Turn all existing rows into a loopable array
                        $rows.each(function () {
                            var $td = $(this).find('td');
                            var h = {};

                            // Use the headers from earlier to name our hash keys
                            headers.forEach(function (header, i) {
                                h[header] = $td.eq(i).text();
                            });

                            data.push(h);
                        });
            
                        // Output the result
                        $EXPORT.text(JSON.stringify(data));
                        var fair = JSON.stringify(data);
                        console.log(fair);
                        firebase.database().ref('PM-Form').push({
                            json: fair,
                            name: $('#FormInputt').val(),
                            number: $('#vVersionn').val()
                        })
                        console.log(arr)
                    });

                }
                r.readAsText(f);
            } else {
                alert("Failed to load file");
            }
        }

        document.getElementById('fileinput').addEventListener('change', readSingleFile, false);

    </script>



    <div id="ex-event" />

    <script src="../../vendor/jquery/jquery.min.js"></script>
    <script src="../../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script src="../../vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Page level plugin JavaScript-->
    <script src="../../vendor/datatables/jquery.dataTables.js"></script>
    <script src="../../vendor/datatables/dataTables.bootstrap4.js"></script>


    <!-- Demo scripts for this page-->
    <script src="../../js/demo/datatables-demo.js"></script>

    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
    <script src="../../firebase/init.js"></script>
    <script src="../../js/route.js"></script>
    <script src="../js/addhtml.js"></script>

</body>

</html>